# DNA Methylation analyses with Illumina Probes - Pipeline 2

This file contains codes for methylation analyses reperformed for this study: https://pmc.ncbi.nlm.nih.gov/articles/PMC10300436/

The objective is to make better sense of epigenomic changes in mice related to the Gulf War disease

## 1. Setup

```r
# Install required packages
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
library(BiocManager)

BiocManager::install(c("minfi", 
                       "limma",
                       "pheatmap",
                       "DMRcate",
                       "clusterProfiler",
                       "biomaRt",
                       "org.Mm.eg.db")

if(!require(devtools)) install.packages("devtools")
devtools::install_github("chiaraherzog/IlluminaMouseMethylationmanifest")
devtools::install_github("chiaraherzog/IlluminaMouseMethylationanno.12.v1.mm10")


# Load packages
library(stringr)
library(rngtools)
library(Gviz)
library(glue)

library(minfi)
library(limma)
library(pheatmap)
library(DMRcate)
library(clusterProfiler)
library(biomaRt)

library(org.Mm.eg.db)
library(IlluminaMouseMethylationanno.12.v1.mm10)
library(IlluminaMouseMethylationmanifest)

sessionInfo()
```

---

## 2. Reading IDAT Files

```r
# Set directory containing IDAT files
raw_dir <- "data/raw"

# Read IDAT files with sample sheet
targets <- read.metharray.sheet(raw_dir)
RGset <- read.metharray.exp(targets = targets)

# Check data
RGset
dim(RGset)
pData(RGset)
annotation(RGset)
```

### Specify Mouse Array Type

```r
RGset@annotation <-  c(array = "IlluminaMouseMethylation", annotation = "12.v1.mm10")

annotation(RGset)
```

---

## 3. Quality Control

### Generate QC Report

```r
# Comprehensive QC report
qcReport(RGset,
         sampNames = pData(RGset)$Sample_Group,
         pdf = "results/methylation_study_qcReport.pdf")
```

### Compute detection P-values

```r
# Calculate detection p-values
detP <- detectionP(RGset)

# Check overall quality
mean_detP <- colMeans(detP)
print(paste("Samples with mean detection p-value < 0.01:",
            sum(mean_detP < 0.01), "out of", length(mean_detP)))

# Visualize detection p-values
par(mfrow = c(1, 2))

## Distribution histogram
hist(detP, breaks = 100, 
     main = "Distribution of Detection P-values",
     xlab = "Detection P-value")
abline(v = 0.01, col = "red", lwd = 2)

## Density plot by group
densityPlot(RGset, sampGroups = pData(RGset)$Sample_Group,
            main = "Raw Data Density by Sample")

# Save results
dev.copy(pdf, "results/detection_pvalues.pdf", width=10)
dev.off()
```

### Check Signal Intensities

```r
# Get raw intensities
green <- getGreen(RGset)
red <- getRed(RGset)

# Calculate median intensities (should be >1000 for good quality)
median_green <- apply(green, 2, median)
median_red <- apply(red, 2, median)

# Visualize signal intensities
par(mfrow = c(1, 2))
barplot(median_green, las = 2, 
        main = "Median Green Channel Intensity",
        ylab = "Intensity", col = "green3",
        cex.names = 0.7)
abline(h = 1000, col = "red", lwd = 2)

barplot(median_red, las = 2, 
        main = "Median Red Channel Intensity",
        ylab = "Intensity", col = "red3",
        cex.names = 0.7)
abline(h = 1000, col = "red", lwd = 2)

dev.copy(pdf, "results/signal_intensities.pdf", width=10)
dev.off()

# Identify low intensity samples
low_intensity <- median_green < 1000 | median_red < 1000
if (any(low_intensity)) {
    cat("Warning: Low intensity samples detected:\n")
    print(names(which(low_intensity)))
}
```

### Remove Poor Quality Samples

```r
cat("Samples before:", ncol(RGset), "\n")

# Remove samples with mean detection p-value > 0.01
keep_samples <- mean_detP < 0.01
RGset <- RGset[, keep_samples]

cat("Samples remaining:", ncol(RGset), "\n")
```

---

## 4. Normalization


```r
# Perform Noob normalization (recommended for data with decode issues)
MSet <- preprocessNoob(RGset)

# Check normalization results
densityPlot(MSet, main = "After Normalization")
```

---

## 5. Probe Filtering

```r
cat("Probes before detection filtering:", nrow(MSet), "\n")

# Filter by detection p-value
# Remove probes with detection p > 0.01 in ANY sample
detP_filtered <- detP[match(featureNames(MSet), rownames(detP)), ]
keep_probes <- rowSums(detP_filtered < 0.01) == ncol(MSet)
MSet <- MSet[keep_probes, ]

cat("Probes after detection filtering:", nrow(MSet), "\n")

# Get annotation
annot <- getAnnotation(MSet)

cat("Probes before removing sex chromosomes:", nrow(MSet), "\n")

# Remove sex chromosome probes (optional, if analyzing mixed-sex cohorts)
keep_auto <- !(annot$chr %in% c("chrX", "chrY"))
MSet <- MSet[keep_auto, ]
cat("Probes after removing sex chromosomes:", nrow(MSet), "\n")
```

---

## 6. Extracting Methylation Values

```r
# Get Beta values (0-1 scale, intuitive interpretation)
beta <- getBeta(MSet)
dim(beta)
head(beta[, 1:5])

# Get M-values (log2 ratio, better for statistics)
M <- getM(MSet)

# Visualize distributions
par(mfrow = c(1, 2))
densityPlot(beta, sampGroups = pData(MSet)$Sample_Group,
            main = "Beta Values", xlab = "Beta")
densityPlot(M, sampGroups = pData(MSet)$Sample_Group,
            main = "M-Values", xlab = "M-value")

dev.copy(pdf, "results/distribution_methylation_values.pdf", width=10)
dev.off()

# Plot MDS to check for outliers
plotMDS(M, labels = pData(MSet)$Sample_Group,
        col = as.numeric(factor(pData(MSet)$Sample_Group)),
        main = "MDS Plot - Sample Similarity")
legend("topright", 
       legend = levels(factor(pData(MSet)$Sample_Group)),
       col = 1:length(levels(factor(pData(MSet)$Sample_Group))),
       pch = 1)
dev.copy(pdf, "results/mds.pdf", width=10)
dev.off()
```

---

## 7. Differential Methylation Analysis

### Setup Design Matrix

```r
# Create design matrix
group <- factor(pData(MSet)$Treatment)
levels(group) <- c("Treated", "Control") # rename properly treatment group
design <- model.matrix(~ 0 + group)
colnames(design) <- levels(group)

# View design
head(design)
```

### Fit Linear Model

```r
# Fit model using M-values (better for statistics)
fit <- lmFit(M, design)

# Define contrasts
contMatrix <- makeContrasts(TreatedVsControl = Treated - Control,
                            levels = design)
fit2 <- contrasts.fit(fit, contMatrix)
fit2 <- eBayes(fit2)

# Get all regions differential methylated
results <- topTable(fit2, num = Inf, coef = 1)

# Compute delta beta (biological effect size between treated and control)
results$deltaBeta <- rowMeans(beta[rownames(results),
                                    group == "Treated"]) - 
                     rowMeans(beta[rownames(results), 
                                    group == "Control"])

# View top results
head(results)
```

### Filter for Significant DMPs

```r
# Differentially Methylated Positions (DMPs)

# Criteria 1: FDR < 0.05
sig_dmps <- subset(results, adj.P.Val < 0.05)

cat("Total significant DMPs:", nrow(sig_dmps), "\n")

# View top significant DMPs
head(sig_dmps[order(sig_dmps$adj.P.Val), ])


# Criteria 2: |delta beta| > 0.2
rel_dmps <- subset(results, abs(deltaBeta) > 0.05)

cat("Hypermethylated DMPs (delta beta > 0.05):", 
    sum(rel_dmps$deltaBeta > 0.05), "\n")
cat("Hypomethylated DMPs (delta beta < -0.05):", 
    sum(rel_dmps$deltaBeta < -0.05), "\n")

# View top relevant DMPs
head(rel_dmps[order(abs(rel_dmps$deltaBeta)), ])

# Combine significant and relevant DMPs
final_dmps <- unique(rbind(sig_dmps, rel_dmps))
```

---

## 8. Annotation and Gene Mapping of DMPs

```r
# Add gene annotation to results
results$gene <- annot[rownames(results), "GeneName_UCSC"]
results$gene_group <- annot[rownames(results), "Feature_UCSC"]
results$chr <- annot[rownames(results), "chr"]
results$pos <- annot[rownames(results), "pos"]
results$strand <- annot[rownames(results), "strand"]

# View annotated results
head(results[, c("gene", "gene_group", "chr", "pos", 
                 "deltaBeta", "adj.P.Val")])

# Annotate DMPs of interest
final_dmps$gene <- annot[rownames(final_dmps), "GeneName_UCSC"]
final_dmps$gene_group <- annot[rownames(final_dmps), "Feature_UCSC"]
final_dmps$chr <- annot[rownames(final_dmps), "chr"]
final_dmps$pos <- annot[rownames(final_dmps), "pos"]
final_dmps$pos <- annot[rownames(final_dmps), "strand"]

# View annotated final DMPs
head(final_dmps)


# Export results
write.csv(results, "results/methylation_all_results.csv", row.names = TRUE)
write.csv(final_dmps, "results/methylation_interest_DMPs.csv", row.names = TRUE)
```

---

## 9. Visualization of DMPs

### Generate Volcano Plot

```r
# Create volcano plot of DMP results
plot(results$deltaBeta, -log10(results$P.Value),
     pch = 16, cex = 0.5, col = "grey",
     xlab = "Delta Beta (Methylation Difference)",
     ylab = "-log10(P-value)",
     main = "Mouse Differential Methylation")

# Highlight significant DMPs
points(sig_dmps$deltaBeta, -log10(sig_dmps$P.Value),
       pch = 16, cex = 0.5, col = "red")

# Add threshold lines
abline(h = -log10(0.05), col = "blue", lty = 2)  # P-value threshold
abline(v = c(-0.2, 0.2), col = "blue", lty = 2)  # Delta beta threshold

# Add legend
legend("topright", 
       legend = c("Significant", "Not significant"),
       col = c("red", "grey"), pch = 16)
dev.copy(pdf, "results/volcano_DMPs.pdf", width=10)
dev.off()
```

### Construct Heatmap of Top DMPs

```r
heatmap_dmps <- function(dmps, label){
    # Select most significant DMPs
    top_probes <- rownames(dmps[order(dmps$adj.P.Val), ])

    # Create annotation for samples
    sample_annotation <- data.frame(
        Group = factor(pData(MSet)$Treatment, levels = c("Control", "CD+DFP")),
        row.names = colnames(beta)
    )

    # Order annotation and beta-values by group
    col_order <- order(sample_annotation$Group)
    beta_ordered <- beta[top_probes, col_order]
    sample_annotation_ordered <- sample_annotation[col_order, , drop = FALSE]

    # Generate heatmap
    pdf(glue("results/heatmap_{label}_DMPs.pdf"), width=12, height=8)
    pheatmap(beta_ordered,
         scale = "none",
         show_rownames = TRUE,
         annotation_col = sample_annotation_ordered,
         main = "Top DMPs - Beta Values",
         color = colorRampPalette(c("blue", "white", "red"))(100),
         clustering_distance_rows = "euclidean",
         cluster_cols = FALSE)
    dev.off()
}

# Plot heatmap all DMPs of interest
heatmap_dmps(final_dmps, "interest")

# Plot heatmap for only significant DMPs
heatmap_dmps(sig_dmps, "significant")
```

### Evaluate Distribution of DMPs Across Genome

```r
# Get chromosome distribution of significant DMPs
chr_counts <- table(final_dmps$chr)

# Order chromosomes properly
chr_order <- paste0("chr", c(1:19, "X", "Y"))
chr_counts <- chr_counts[chr_order[chr_order %in% names(chr_counts)]]

barplot(chr_counts,
        las = 2,
        main = "Distribution of DMPs Across Chromosomes",
        ylab = "Number of DMPs",
        xlab = "Chromosome",
        col = "cadetblue")
dev.copy(pdf, "results/dmp_distribution_chromosomes.pdf", width=10)
dev.off()
```

### Assess Distribution Gene Region

```r
# Get distribution across gene regions
region_counts <- table(final_dmps$gene_group)

# Split multiple annotations (some probes map to multiple regions)
regions_split <- unlist(strsplit(as.character(final_dmps$gene_group), ";"))
region_table <- table(regions_split)

barplot(sort(region_table, decreasing = TRUE),
        las = 2,
        main = "DMPs by Gene Region",
        ylab = "Number of DMPs",
        col = "coral",
        cex.names = 0.8)
dev.copy(pdf, "results/gene_region_distribution.pdf", width=10)
dev.off()
```

### Draw Boxplots for Selected Probes

```r
# Example: Plot beta values for top 6 DMPs
par(mfrow = c(2, 3))
top_6 <- rownames(sig_dmps)[1:6]

for (probe in top_6) {
    boxplot(beta[probe, ] ~ pData(MSet)$Treatment,
            main = paste0(probe, "\n", 
                         annot[probe, "GeneName_UCSC"]),
            ylab = "Beta Value",
            xlab = "",
            col = c("lightblue", "lightcoral"))
}
dev.copy(pdf, "results/boxplot_beta_top6_dmps.pdf", width=10)
dev.off()
```

---

## 10. Differentially Methylated Regions (DMRs)

DMRs are genomic regions with multiple adjacent differentially methylated CpGs.

```r
# Transform methylation matrix to genomic ratio set
GRset <- makeGenomicRatioSetFromMatrix(M,
                                       pData = pData(MSet),
                                       array = "IlluminaMouseMethylation",
                                       annotation = "12.v1.mm10",
                                       what = "M")

# Compute DMRs with bumphunter

dmrs <- bumphunter(GRset,
                   design = design,
                   coef = 1,
                   cutoff = 0.05,
                   B = 5,
                   type = "M",
                   maxGap = 500,
                   nullMethod = "permutation")

# Transform results to genomic ranges
results.ranges <- GRanges(seqnames = dmrs$table$chr,
                          ranges = IRanges(start = dmrs$table$start,
                                           end = dmrs$table$end),
                          value = dmrs$table$value,
                          area = dmrs$table$area,
                          L = dmrs$table$L,
                          pvalue = dmrs$table$p.value,
                          fwer = dmrs$table$fwer)

# View top DMRs
head(results.ranges)

# Export DMRs
write.csv(as.data.frame(results.ranges), 
          "results/methylation_DMRs.csv", 
          row.names = FALSE)
```

### Plot Individual DMRs

```r
# Create group colors
groups <- factor(pData(MSet)$Treatment)
group_pal <- c("Control" = "blue", "Treatment" = "red")
group_colors <- group_pal[groups]


# Plot multiple DMRs
for (i in 1:min(3, length(results.ranges))) {
    DMR.plot(ranges = results.ranges, 
             dmr = i,
             CpGs = GRset, 
             phen.col = group_colors,
             heatmap=FALSE,
             genome = "mm10")
    dev.copy(pdf, glue("results/dmr{i}.pdf"), width=20, height=10)
    dev.off()
}
```

---

## 11. Functional Analysis

### Perform Gene Ontology Enrichment

```r
# Extract unique genes from significant DMPs
final_genes <- unique(unlist(strsplit(as.character(final_dmps$gene), ";")))
final_genes <- final_genes[final_genes != ""]
final_genes <- na.omit(final_genes)

cat("Number of unique genes with DMPs:", length(final_genes), "\n")

# Convert gene UNIPROT IDs to Entrez IDs
mouse_mart <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")
genes_entrez <- getBM(attributes = c("uniprotswissprot", "uniprotsptrembl", 
                                     "entrezgene_id", "external_gene_name"),
                      filters = "uniprotswissprot",
                      values = final_genes,
                      mart = mouse_mart)

gene_list <- genes_entrez$entrezgene_id

# Execute GO enrichment analysis
geo <- function(gene_list, ont_type){
    ego <- enrichGO(gene = gene_list,
                OrgDb = org.Mm.eg.db,
                ont = ont_type,
                pAdjustMethod = "fdr",
                qvalueCutoff = 0.05,
                readable = TRUE)
}

bp_geo <- geo(gene_list, "BP")
mf_geo <- geo(gene_list, "MF")
cc_geo <- geo(gene_list, "CC")

# Draw barplot of results
barplot(ego, showCategory = 20)
# Draw dotplot of results
dotplot(ego, showCategory = 20)
```

### KEGG Pathway Analysis

```r
# Execute KEGG enrichment test
kegg <- enrichKEGG(gene = gene_list,
                   organism = 'mmu',  # mouse
                   pvalueCutoff = 0.05)

# View results
head(kegg)

# Draw barplot of results
barplot(kegg)
dev.copy(pdf, "results/barplot_kegg_results.pdf", width=10)
dev.off()

# Draw dotplot of results
dotplot(kegg)
dev.copy(pdf, "results/dotplot_kegg_results.pdf", width=10)
dev.off()

# Create list of genes and kegg for follow-up

final_genes_kegg <- data.frame()

kegg_data <- kegg[]

for (i in seq_len(nrow(kegg_data))) {
  genes <- strsplit(kegg_data$geneID[i], "/")[[1]]
  genes <- as.integer(genes)
  
  matches <- genes_entrez$entrezgene_id %in% genes
  
  if (any(matches)) {
    temp <- data.frame(
      pathway_id = kegg_data$ID[i],
      pathway_description = kegg_data$Description[i],
      gene_symbol = genes_entrez$external_gene_name[matches],
      entrez_id = genes_entrez$entrezgene_id[matches],
      stringsAsFactors = FALSE
    )
    final_genes_kegg <- rbind(final_genes_kegg, temp)
  }
}

final_genes_kegg <- unique(final_genes_kegg)
write.csv(final_genes_kegg, "results/list_genes_kegg.csv", row.names=FALSE)
```
---

## 12. Creating phenotype files with methylation data

```r
# Read experiment metadata
metadata <- read.csv("data/raw/sample_sheet.csv")

# Save covariates
covariates <- metadata[c("Strain", "Sex", "Age", "AgeDays", "Treatment")]
write.csv(covariates, "results/covariates.csv", row.names=FALSE)


# Save methylation phenotypes
methyl_pheno <- beta

colnames(methyl_pheno) <- metadata$Strain[match(colnames(methyl_pheno), metadata$ExtBasename)]

trans_methyl_pheno <- t(methyl_pheno)

write.csv(trans_methyl_pheno, "~/methylation_phenofile.csv", row.names=FALSE) # without strains

write.csv(trans_methyl_pheno, "~/methylation_phenofile_strains.csv", row.names=TRUE) # with strains

```

---

## 13. Saving Results

```r
# Create summary report
sink("results/methylation_summary.txt")
cat("=== Mouse Methylation Analysis Summary ===\n\n")
cat("Date:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n\n")
cat("Number of samples:", ncol(MSet), "\n")
cat("Number of probes analyzed:", nrow(MSet), "\n")
cat("Experimental groups:", paste(levels(group), collapse = ", "), "\n\n")
cat("Significant DMPs (FDR < 0.05,):", nrow(sig_dmps), "\n")
cat("DMPs of interest:", nrow(final_dmps), "\n")
cat("  - Hypermethylated:", sum(final_dmps$deltaBeta > 0.05), "\n")
cat("  - Hypomethylated:", sum(final_dmps$deltaBeta < -0.05), "\n\n")
cat("Number of DMRs found:", length(results.ranges), "\n")
cat("Number of genes found in DMPs of interest:", length(final_genes), "\n")
cat("Number of gene ontologies of relevance at molecular level", nrow(mf_geo), "\n")
cat("Number of pathways of relevance:", nrow(kegg), "\n")
sink()

cat("\nAnalysis complete!\n")
```

