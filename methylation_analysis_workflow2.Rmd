# DNA Methylation analyses with Illumina Probes - Pipeline 2

This file contains codes for methylation analyses reperformed for this study: https://pmc.ncbi.nlm.nih.gov/articles/PMC10300436/

The objective is to make better sense of epigenomic changes in mice related to the Gulf War disease

## 1. Prepare setup

```r
# Install required packages
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
library(BiocManager)

BiocManager::install(c("minfi", 
                       "limma",
                       "pheatmap",
                       "DMRcate"))

if(!require(devtools)) install.packages("devtools")
devtools::install_github("chiaraherzog/IlluminaMouseMethylationmanifest")
devtools::install_github("chiaraherzog/IlluminaMouseMethylationanno.12.v1.mm10")

# Load packages
library(minfi)
library(limma)
library(DMRcate)
library(pheatmap)
library(IlluminaMouseMethylationanno.12.v1.mm10)
library(IlluminaMouseMethylationmanifest)

sessionInfo()
```

---

## 2. Read IDAT Files

```r
# Set directory containing IDAT files
baseDir <- "data/raw"

# Read IDAT files with sample sheet
targets <- read.metharray.sheet(baseDir)
RGset <- read.metharray.exp(targets = targets)

# Check data
RGset
dim(RGset)
pData(RGset)
annotation(RGset)
```

### Specify Mouse Array Type

```r
RGset@annotation <-  c(array = "IlluminaMouseMethylation", annotation = "12.v1.mm10")

annotation(RGset)
```

---

## 3. Quality Control

### Generate QC Report

```r
# Comprehensive QC report
qcReport(RGset,
         sampNames = pData(RGset)$Sample_Group,
         pdf = "methylation_study_qcReport.pdf")
```

### Compute detection P-values

```r
# Calculate detection p-values
detP <- detectionP(RGset)

# Check overall quality
mean_detP <- colMeans(detP)
print(paste("Samples with mean detection p-value < 0.01:", 
            sum(mean_detP < 0.01), "out of", length(mean_detP)))

# Visualize detection p-values
par(mfrow = c(2, 2))

## Bar plot per sample
barplot(mean_detP, 
        las = 2, 
        ylim = c(0, max(mean_detP) * 1.1),
        main = "Mean Detection P-values",
        ylab = "Mean Detection P-value",
        cex.names = 0.7)
abline(h = 0.01, col = "red", lwd = 2)

## Distribution histogram
hist(detP, breaks = 100, 
     main = "Distribution of Detection P-values",
     xlab = "Detection P-value")
abline(v = 0.01, col = "red", lwd = 2)

## Failed probes per sample
failed_probes <- colSums(detP > 0.01)
barplot(failed_probes,
        las = 2,
        main = "Number of Failed Probes per Sample",
        ylab = "Number of probes with p > 0.01",
        cex.names = 0.7)

## Density plot by group
densityPlot(RGset, sampGroups = pData(RGset)$Sample_Group,
            main = "Raw Data Density by Group")
```

### Check Signal Intensities

```r
# Get raw intensities
green <- getGreen(RGset)
red <- getRed(RGset)

# Calculate median intensities (should be >1000 for good quality)
median_green <- apply(green, 2, median)
median_red <- apply(red, 2, median)

par(mfrow = c(1, 2))
barplot(median_green, las = 2, 
        main = "Median Green Channel Intensity",
        ylab = "Intensity", col = "green3",
        cex.names = 0.7)
abline(h = 1000, col = "red", lwd = 2)

barplot(median_red, las = 2, 
        main = "Median Red Channel Intensity",
        ylab = "Intensity", col = "red3",
        cex.names = 0.7)
abline(h = 1000, col = "red", lwd = 2)

# Identify low intensity samples
low_intensity <- median_green < 1000 | median_red < 1000
if (any(low_intensity)) {
    cat("Warning: Low intensity samples detected:\n")
    print(names(which(low_intensity)))
}
```

### Remove Poor Quality Samples

```r
cat("Samples before:", ncol(RGset), "\n")

# Remove samples with mean detection p-value > 0.01
keep_samples <- mean_detP < 0.01
RGset <- RGset[, keep_samples]

cat("Samples remaining:", ncol(RGset), "\n")
```

---

## 4. Normalization


```r
# Option A: Perform Noob normalization (recommended for data with decode issues)
MSet <- preprocessNoob(RGset)

# Option B: Quantile normalization
MSet <- preprocessQuantile(RGset)

# Option C: SWAN 
MSet <- preprocessSWAN(RGset)


# Check normalization
densityPlot(MSet, main = "After Normalization")
```

---

## 5. Probe Filtering

```r
cat("Probes before detection filtering:", nrow(MSet), "\n")

# Filter by detection p-value
# Remove probes with detection p > 0.01 in ANY sample
detP_filtered <- detP[match(featureNames(MSet), rownames(detP)), ]
keep_probes <- rowSums(detP_filtered < 0.01) == ncol(MSet)
MSet <- MSet[keep_probes, ]

cat("Probes after detection filtering:", nrow(MSet), "\n")

# Get annotation
annot <- getAnnotation(MSet)

cat("Probes before removing sex chromosomes:", nrow(MSet), "\n")

# Remove sex chromosome probes (optional, if analyzing mixed-sex cohorts)
keep_auto <- !(annot$chr %in% c("chrX", "chrY"))
MSet <- MSet[keep_auto, ]
cat("Probes after removing sex chromosomes:", nrow(MSet), "\n")
```

---

## 6. Extract Methylation Values

```r
# Get Beta values (0-1 scale, intuitive interpretation)
beta <- getBeta(MSet)
dim(beta)
head(beta[, 1:5])

# Get M-values (log2 ratio, better for statistics)
M <- getM(MSet)

# Visualize distributions
par(mfrow = c(1, 2))
densityPlot(beta, sampGroups = pData(MSet)$Sample_Group,
            main = "Beta Values", xlab = "Beta")
densityPlot(M, sampGroups = pData(MSet)$Sample_Group,
            main = "M-Values", xlab = "M-value")

# Plot MDS to check for outliers
plotMDS(M, labels = pData(MSet)$Sample_Group,
        col = as.numeric(factor(pData(MSet)$Sample_Group)),
        main = "MDS Plot - Sample Similarity")
legend("topright", 
       legend = levels(factor(pData(MSet)$Sample_Group)),
       col = 1:length(levels(factor(pData(MSet)$Sample_Group))),
       pch = 1)
```

---

## 7. Differential Methylation Analysis

### Setup Design Matrix

```r
# Create design matrix
group <- factor(pData(MSet)$Treatment)
levels(group) <- c("Treated", "Control") # rename properly treatment group
design <- model.matrix(~ 0 + group)
colnames(design) <- levels(group)

# View design
head(design)
```

### Fit Linear Model

```r
# Fit model using M-values (better for statistics)
fit <- lmFit(M, design)

# Define contrasts
contMatrix <- makeContrasts(Treated - Control, levels = design)
fit2 <- contrasts.fit(fit, contMatrix)
fit2 <- eBayes(fit2)

# Get all regions differential methylated
results <- topTable(fit2, num = Inf, coef = 1)

# Compute delta beta (biological effect size between treated and control)
results$deltaBeta <- rowMeans(beta[rownames(results),
                                    group == "Treated"]) - 
                     rowMeans(beta[rownames(results), 
                                    group == "Control"])

# View top results
head(results)
```

### Filter for Significant DMPs

```r
# Differentially Methylated Positions (DMPs)
# Criteria: FDR < 0.05 and |delta beta| > 0.2
sig_dmps <- subset(results, adj.P.Val < 0.05 & abs(deltaBeta) > 0.05)

cat("Total significant DMPs:", nrow(sig_dmps), "\n")
cat("Hypermethylated (delta beta > 0.2):", 
    sum(sig_dmps$deltaBeta > 0.05), "\n")
cat("Hypomethylated (delta beta < -0.2):", 
    sum(sig_dmps$deltaBeta < -0.05), "\n")

# View top DMPs
head(sig_dmps[order(sig_dmps$adj.P.Val), ])
```

---

## 8. Annotation and Gene Mapping

```r
# Add gene annotation to results
annot <- getAnnotation(MSet)

results$gene <- annot[rownames(results), "UCSC_RefGene_Name"]
results$gene_group <- annot[rownames(results), "UCSC_RefGene_Group"]
results$chr <- annot[rownames(results), "chr"]
results$pos <- annot[rownames(results), "pos"]
results$strand <- annot[rownames(results), "strand"]

# View annotated results
head(results[, c("gene", "gene_group", "chr", "pos", 
                 "deltaBeta", "adj.P.Val")])

# Annotate significant DMPs
sig_dmps$gene <- annot[rownames(sig_dmps), "UCSC_RefGene_Name"]
sig_dmps$gene_group <- annot[rownames(sig_dmps), "UCSC_RefGene_Group"]
sig_dmps$chr <- annot[rownames(sig_dmps), "chr"]
sig_dmps$pos <- annot[rownames(sig_dmps), "pos"]

# Export results
write.csv(results, "mouse_methylation_all_results.csv", row.names = TRUE)
write.csv(sig_dmps, "mouse_methylation_significant_DMPs.csv", row.names = TRUE)
```

---

## 9. Visualization

### Volcano Plot

```r
# Create volcano plot
plot(results$deltaBeta, -log10(results$P.Value),
     pch = 16, cex = 0.5, col = "grey",
     xlab = "Delta Beta (Methylation Difference)",
     ylab = "-log10(P-value)",
     main = "Volcano Plot: Mouse Methylation")

# Highlight significant DMPs
points(sig_dmps$deltaBeta, -log10(sig_dmps$P.Value),
       pch = 16, cex = 0.5, col = "red")

# Add threshold lines
abline(h = -log10(0.05), col = "blue", lty = 2)  # P-value threshold
abline(v = c(-0.2, 0.2), col = "blue", lty = 2)  # Delta beta threshold

# Add legend
legend("topright", 
       legend = c("Significant", "Not significant"),
       col = c("red", "grey"), pch = 16)
```

### Heatmap of Top DMPs

```r
library(pheatmap)

# Select top 50 most significant DMPs
top_probes <- rownames(sig_dmps[order(sig_dmps$adj.P.Val), ])[1:50]

# Create annotation for samples
sample_annotation <- data.frame(
    Group = pData(MSet)$Sample_Group,
    row.names = colnames(beta)
)

# Generate heatmap
pheatmap(beta[top_probes, ],
         scale = "none",
         show_rownames = FALSE,
         annotation_col = sample_annotation,
         main = "Top 50 DMPs - Beta Values",
         color = colorRampPalette(c("blue", "white", "red"))(100),
         clustering_distance_rows = "euclidean",
         clustering_distance_cols = "euclidean")
```

### Distribution of DMPs Across Genome

```r
# Chromosome distribution of significant DMPs
chr_counts <- table(sig_dmps$chr)

# Order chromosomes properly
chr_order <- paste0("chr", c(1:19, "X", "Y"))
chr_counts <- chr_counts[chr_order[chr_order %in% names(chr_counts)]]

barplot(chr_counts, 
        las = 2,
        main = "Distribution of DMPs Across Chromosomes",
        ylab = "Number of DMPs",
        xlab = "Chromosome",
        col = "steelblue")
```

### Gene Region Distribution

```r
# Distribution across gene regions
region_counts <- table(sig_dmps$gene_group)

# Split multiple annotations (some probes map to multiple regions)
regions_split <- unlist(strsplit(as.character(sig_dmps$gene_group), ";"))
region_table <- table(regions_split)

barplot(sort(region_table, decreasing = TRUE),
        las = 2,
        main = "DMPs by Gene Region",
        ylab = "Number of DMPs",
        col = "coral",
        cex.names = 0.8)
```

### Box Plots for Selected Probes

```r
# Example: Plot beta values for top 6 DMPs
par(mfrow = c(2, 3))
top_6 <- rownames(sig_dmps)[1:6]

for (probe in top_6) {
    boxplot(beta[probe, ] ~ pData(MSet)$Sample_Group,
            main = paste0(probe, "\n", 
                         annot[probe, "UCSC_RefGene_Name"]),
            ylab = "Beta Value",
            xlab = "",
            col = c("lightblue", "lightcoral"))
}
```

---

## 10. Differentially Methylated Regions (DMRs)

DMRs are genomic regions with multiple adjacent differentially methylated CpGs.

```r
library(DMRcate)

# Annotate CpGs for DMR analysis
myAnnotation <- cpg.annotate(datatype = "array",
                              object = M,
                              what = "M",
                              arraytype = "Mouse",
                              analysis.type = "differential",
                              design = design,
                              contrasts = TRUE,
                              cont.matrix = contMatrix,
                              coef = 1)

# Find DMRs
# lambda = max distance between CpGs (bp)
# C = minimum number of CpGs
DMRs <- dmrcate(myAnnotation, lambda = 1000, C = 2)

# Extract results
results.ranges <- extractRanges(DMRs)

# View top DMRs
head(results.ranges)

# Export DMRs
write.csv(as.data.frame(results.ranges), 
          "mouse_methylation_DMRs.csv", 
          row.names = FALSE)
```

### Plot Individual DMRs

```r
# Plot top DMR
library(Gviz)

# Create group colors
group_colors <- as.numeric(factor(pData(MSet)$Sample_Group))

DMR.plot(ranges = results.ranges, 
         dmr = 1,  # Plot first DMR
         CpGs = beta, 
         phen.col = group_colors,
         genome = "mm10",
         main = "Top DMR")

# Plot multiple DMRs
for (i in 1:min(5, length(results.ranges))) {
    DMR.plot(ranges = results.ranges, 
             dmr = i,
             CpGs = beta, 
             phen.col = group_colors,
             genome = "mm10",
             main = paste("DMR", i))
}
```

---

## 11. Functional Analysis

### Gene Ontology Enrichment

```r
# Extract unique genes from significant DMPs
sig_genes <- unique(unlist(strsplit(as.character(sig_dmps$gene), ";")))
sig_genes <- sig_genes[sig_genes != ""]

cat("Number of unique genes with DMPs:", length(sig_genes), "\n")

# Install GO analysis package
if (!require("clusterProfiler")) {
    BiocManager::install("clusterProfiler")
}
library(clusterProfiler)
library(org.Mm.eg.db)  # Mouse annotation

# Convert gene symbols to Entrez IDs
genes_entrez <- bitr(sig_genes, 
                     fromType = "SYMBOL",
                     toType = "ENTREZID",
                     OrgDb = org.Mm.eg.db)

# GO enrichment analysis
ego <- enrichGO(gene = genes_entrez$ENTREZID,
                OrgDb = org.Mm.eg.db,
                ont = "BP",  # Biological Process
                pAdjustMethod = "BH",
                qvalueCutoff = 0.05,
                readable = TRUE)

# View results
head(ego)

# Plot
barplot(ego, showCategory = 20)
dotplot(ego, showCategory = 20)
```

### KEGG Pathway Analysis

```r
# KEGG enrichment
kegg <- enrichKEGG(gene = genes_entrez$ENTREZID,
                   organism = 'mmu',  # mouse
                   pvalueCutoff = 0.05)

# View results
head(kegg)

# Plot
barplot(kegg, showCategory = 20)
dotplot(kegg, showCategory = 20)
```

---

## 12. Save Results

```r
# Save processed data objects
save(RGset, MSet, beta, M, detP, 
     file = "mouse_methylation_processed_data.RData")

# Save analysis results
save(results, sig_dmps, results.ranges,
     file = "mouse_methylation_analysis_results.RData")

# Create summary report
sink("mouse_methylation_summary.txt")
cat("=== Mouse Methylation Analysis Summary ===\n\n")
cat("Date:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n\n")
cat("Number of samples:", ncol(MSet), "\n")
cat("Number of probes analyzed:", nrow(MSet), "\n")
cat("Experimental groups:", paste(levels(group), collapse = ", "), "\n\n")
cat("Significant DMPs (FDR < 0.05, |delta beta| > 0.2):", nrow(sig_dmps), "\n")
cat("  - Hypermethylated:", sum(sig_dmps$deltaBeta > 0.2), "\n")
cat("  - Hypomethylated:", sum(sig_dmps$deltaBeta < -0.2), "\n\n")
cat("Number of DMRs found:", length(results.ranges), "\n")
cat("Number of genes with DMPs:", length(sig_genes), "\n")
sink()

cat("\nAnalysis complete! Results saved.\n")
```

---

## Troubleshooting

### Common Issues

**Problem**: Error reading IDAT files
```r
# Solution: Force reading and check file naming
RGset <- read.metharray.exp(base = baseDir, recursive = TRUE, force = TRUE)

# Check files are named correctly: SampleID_Grn.idat and SampleID_Red.idat
list.files(baseDir, pattern = ".idat")
```

**Problem**: Missing annotation package
```r
# Solution: Install manually
BiocManager::install("IlluminaMouseMethylationanno.12.v1.mm10")

# Or check available annotations
library(AnnotationHub)
ah <- AnnotationHub()
query(ah, "Mouse Methylation")
```

**Problem**: Low detection rates
```r
# Check individual sample quality
mean_detP <- colMeans(detP)
print(mean_detP)

# Remove problematic samples
keep <- mean_detP < 0.01
RGset <- RGset[, keep]
```

---

## Key Points to Remember

1. **Use M-values for statistics** (linear modeling) but **beta-values for biological interpretation** (methylation percentages)

2. **Detection p-values** identify failed probes - filter these out early

3. **Delta beta > 0.2** (20% methylation difference) is commonly used as biological significance threshold

4. **Mouse arrays** have ~285K probes covering ~20,000 genes in mm10 genome

5. **Your decode statistics** (98.5% success rate) indicate excellent quality data

6. **Normalization choice matters** - Noob is good for data with some technical variation

7. **DMRs are often more biologically meaningful** than individual DMPs

---

## Additional Resources

- **minfi User Guide**: https://bioconductor.org/packages/release/bioc/vignettes/minfi/inst/doc/minfi.html
- **DMRcate Documentation**: https://bioconductor.org/packages/release/bioc/html/DMRcate.html
- **Mouse Genome (mm10)**: https://genome.ucsc.edu/cgi-bin/hgGateway?db=mm10
- **Illumina Support**: https://support.illumina.com/

---

## Session Info

Always include session information in your analysis reports:

```r
sessionInfo()
```

This captures R version, package versions, and system information for reproducibility.
